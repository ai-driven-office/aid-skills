# ISO 21496-1 Gain Map Standard

## Overview

ISO 21496-1 (published October 2024) defines a unified format for backward-compatible HDR images using gain maps. It replaces the previously incompatible Apple, Adobe, and Android proprietary formats.

## How Gain Maps Work

A gain map image stores **per-pixel multipliers** that expand an SDR base image into HDR:

```
HDR_pixel = SDR_pixel * gain_map_value^(headroom)
```

The display applies the gain map based on its actual HDR capability (headroom in stops):

```
displayed_pixel = SDR_pixel * gain_map_value^(min(device_headroom, max_headroom) / max_headroom)
```

- **0 headroom** (SDR display) → Shows SDR base unmodified
- **Partial headroom** (1.5-3 stops) → Proportional HDR expansion
- **Full headroom** (matches max) → Full HDR as intended

## Key Metadata Fields

| Field | Type | Description |
|-------|------|-------------|
| `gainMapMin` | float | Minimum gain value (usually 0 or negative for shadow compression) |
| `gainMapMax` | float | Maximum gain value in log2 (headroom in stops) |
| `gainMapGamma` | float | Gamma curve for gain map values (1.0 = linear) |
| `offsetSDR` | float | SDR black point offset |
| `offsetHDR` | float | HDR black point offset |
| `hdrCapacityMin` | float | Minimum headroom where gain map applies |
| `hdrCapacityMax` | float | Maximum headroom for full HDR |
| `useBaseColorSpace` | bool | Whether to use base image's color space for gain map |

## Container Formats

### JPEG (MPF — Multi-Picture Format)
- SDR base image as primary JPEG
- Gain map as secondary JPEG within MPF container
- Metadata in APP11 marker (ISO box format)
- **Advantage:** Universal SDR fallback, compatible with all viewers

### AVIF
- SDR base as primary image item
- Gain map as auxiliary image item
- Metadata in `tmap` box
- **Advantage:** Better compression, native HDR support

## RGB vs Luminosity Gain Maps

### RGB (3-channel)
- Separate gain per R, G, B channel
- **Pro:** Preserves color shifts in HDR (e.g., warm highlights, cool shadows)
- **Con:** 3x larger gain map
- **Use when:** Color accuracy in HDR is critical

### Luminosity (1-channel)
- Single gain value applied equally to all channels
- **Pro:** Smallest file size
- **Con:** Cannot represent color changes between SDR and HDR
- **Use when:** File size matters more than color precision

## Common Problems

### 1. Poor SDR Fallback (The #1 Issue)
Auto-generated SDR base images from tools like Lightroom often:
- Oversaturate colors
- Clip highlights (hard white)
- Wash out shadows
- Lose mid-tone contrast

**Fix:** Manually edit SDR base with `uhd-gain-map-editor edit` to tune brightness, contrast, and saturation independently.

### 2. Exceeding Viewer Headroom
If gain map max headroom is 4 stops but viewer has 1.5 stops:
- Gain map is compressed into 1.5 stops
- Subtle HDR gradients become harsh steps
- Highlights may clip at viewer's limit

**Fix:** Target 2.5 stops as default. Use `--headroom 2.5`.

### 3. Half-Resolution Gain Maps
Some tools (including Lightroom AVIF export) produce gain maps at half the base image resolution. This causes:
- Loss of fine highlight detail
- Visible gain map artifacts at edges
- Staircase effects in gradual HDR transitions

**Fix:** Use `--map-resolution full` in gain map creation.

### 4. Platform Stripping
Many platforms strip gain maps during upload/transcoding:
- WordPress strips on media library upload
- Most social platforms (except Instagram/Threads) strip
- CDNs may transcode and remove gain map data

**Fix:** Use platforms that preserve gain maps, or serve directly via CDN with no-transcode rules.
